import os
import sys
import asyncio
import subprocess
import tempfile
import shutil
from pathlib import Path
from typing import Optional

from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import Message, FSInputFile, BufferedInputFile
from aiogram.enums import ParseMode

# ============================================
# –ù–ê–°–¢–†–û–ô–ö–ò - –¢–û–õ–¨–ö–û –≠–¢–û –ù–£–ñ–ù–û –ò–ó–ú–ï–ù–ò–¢–¨!
# ============================================
BOT_TOKEN = "8478108815:AAEhrJnxYB-RoGJYK7S2RxO_nE9dwkgQhIg"  # –í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à —Ç–æ–∫–µ–Ω –æ—Ç @BotFather
DEOBFUSCATOR_PATH = "/app/Prometheus-Deobfuscator/pol.py"  # –ü–†–ê–í–ò–õ–¨–ù–´–ô –ü–£–¢–¨
PYTHON_PATH = "python3"  # –ù–∞ Linux –≤—Å–µ–≥–¥–∞ python3
TEMP_DIR = "/app/bot_temp"  # –ü–∞–ø–∫–∞ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

# ============================================
# –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–û–¢–ê
# ============================================
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
os.makedirs(TEMP_DIR, exist_ok=True)
os.makedirs(os.path.dirname(DEOBFUSCATOR_PATH), exist_ok=True)

# ============================================
# –ü–†–û–í–ï–†–ö–ê –î–ï–û–ë–§–£–°–ö–ê–¢–û–†–ê –ü–†–ò –ó–ê–ü–£–°–ö–ï
# ============================================
async def check_deobfuscator():
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–µ–æ–±—Ñ—É—Å–∫–∞—Ç–æ—Ä–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ"""
    if not os.path.exists(DEOBFUSCATOR_PATH):
        print(f"‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –î–µ–æ–±—Ñ—É—Å–∫–∞—Ç–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –ø—É—Ç–∏: {DEOBFUSCATOR_PATH}")
        print("üîç –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:")
        print("   1. –ß—Ç–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å–∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω: git clone https://github.com/0x251/Prometheus-Deobfuscator.git")
        print("   2. –ß—Ç–æ –ø—É—Ç—å —É–∫–∞–∑–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ: /app/Prometheus-Deobfuscator/pol.py")
        print("   3. –ß—Ç–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ls -la /app/Prometheus-Deobfuscator/pol.py")
        return False
    else:
        print(f"‚úÖ –î–µ–æ–±—Ñ—É—Å–∫–∞—Ç–æ—Ä –Ω–∞–π–¥–µ–Ω: {DEOBFUSCATOR_PATH}")
        return True

# ============================================
# –§–£–ù–ö–¶–ò–Ø –î–ï–û–ë–§–£–°–ö–ê–¶–ò–ò
# ============================================
async def deobfuscate_lua(input_code: str, filename: str = "script.lua") -> Optional[str]:
    """
    –ó–∞–ø—É—Å–∫–∞–µ—Ç Prometheus Deobfuscator –Ω–∞ –ø–æ–ª—É—á–µ–Ω–Ω–æ–º Lua –∫–æ–¥–µ
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ–æ–±—Ñ—É—Å—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –∏–ª–∏ —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
    """
    
    # –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ –¥–ª—è —Ñ–∞–π–ª–æ–≤
    import uuid
    unique_id = str(uuid.uuid4())[:8]
    input_file = os.path.join(TEMP_DIR, f"input_{unique_id}_{filename}")
    output_file = os.path.join(TEMP_DIR, f"output_{unique_id}_{filename}")
    
    try:
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ö–æ–¥–Ω–æ–π –∫–æ–¥ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        with open(input_file, "w", encoding="utf-8") as f:
            f.write(input_code)
        
        print(f"üìÑ –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {input_file}")
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –¥–µ–æ–±—Ñ—É—Å–∫–∞—Ç–æ—Ä
        process = await asyncio.create_subprocess_exec(
            PYTHON_PATH,
            DEOBFUSCATOR_PATH,
            input_file,
            stdout=asyncio.subprocess.PIPE,
            stderr=asyncio.subprocess.PIPE
        )
        
        # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å —Ç–∞–π–º–∞—É—Ç–æ–º 30 —Å–µ–∫—É–Ω–¥
        try:
            stdout, stderr = await asyncio.wait_for(process.communicate(), timeout=30.0)
        except asyncio.TimeoutError:
            process.kill()
            return "‚ùå –û—à–∏–±–∫–∞: –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (30 —Å–µ–∫—É–Ω–¥)"
        
        # –î–µ–∫–æ–¥–∏—Ä—É–µ–º –≤—ã–≤–æ–¥
        stdout_text = stdout.decode('utf-8', errors='ignore')
        stderr_text = stderr.decode('utf-8', errors='ignore')
        
        print(f"‚úÖ –î–µ–æ–±—Ñ—É—Å–∫–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –∫–æ–¥ –≤–æ–∑–≤—Ä–∞—Ç–∞: {process.returncode}")
        
        if process.returncode != 0:
            if stderr_text:
                return f"‚ùå –û—à–∏–±–∫–∞ –¥–µ–æ–±—Ñ—É—Å–∫–∞—Ü–∏–∏:\n```\n{stderr_text[:500]}\n```"
            else:
                return "‚ùå –û—à–∏–±–∫–∞ –¥–µ–æ–±—Ñ—É—Å–∫–∞—Ü–∏–∏ (–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞)"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ stdout
        if stdout_text and len(stdout_text.strip()) > 0:
            return stdout_text
        else:
            return "‚ùå –û—à–∏–±–∫–∞: –î–µ–æ–±—Ñ—É—Å–∫–∞—Ç–æ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç"
    
    except Exception as e:
        print(f"‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: {str(e)}")
        return f"‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: {str(e)[:200]}"
    
    finally:
        # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
        for file in [input_file, output_file]:
            try:
                if os.path.exists(file):
                    os.remove(file)
                    print(f"üßπ –£–¥–∞–ª–µ–Ω: {file}")
            except:
                pass

# ============================================
# –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î
# ============================================

@dp.message(Command("start"))
async def cmd_start(message: Message):
    """–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"""
    await message.answer(
        "ü§ñ <b>Prometheus Deobfuscator Bot</b>\n\n"
        "üìÅ <b>–û—Ç–ø—Ä–∞–≤—å—Ç–µ Lua-—Ñ–∞–π–ª</b> —Å –æ–±—Ñ—É—Å—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∫–æ–¥–æ–º, –∏ —è –ø–æ–ø—Ä–æ–±—É—é –µ–≥–æ –¥–µ–æ–±—Ñ—É—Å—Ü–∏—Ä–æ–≤–∞—Ç—å!\n\n"
        "üîß <b>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –æ–±—Ñ—É—Å–∫–∞—Ç–æ—Ä—ã:</b>\n"
        "‚Ä¢ Prometheus Obfuscator\n"
        "‚Ä¢ Moonsec V2/V3\n"
        "‚Ä¢ MoonSec\n\n"
        "‚ö° <b>–ö–æ–º–∞–Ω–¥—ã:</b>\n"
        "/start - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ\n"
        "/help - –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞\n"
        "/status - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞",
        parse_mode=ParseMode.HTML
    )

@dp.message(Command("help"))
async def cmd_help(message: Message):
    """–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é"""
    help_text = """
üìö <b>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º:</b>

1Ô∏è‚É£ <b>–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª</b> —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º .lua
2Ô∏è‚É£ –ë–æ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç —Ñ–∞–π–ª –∏ –∑–∞–ø—É—Å—Ç–∏—Ç –¥–µ–æ–±—Ñ—É—Å–∫–∞—Ü–∏—é
3Ô∏è‚É£ –û–∂–∏–¥–∞–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–æ–±—ã—á–Ω–æ 5-30 —Å–µ–∫—É–Ω–¥)
4Ô∏è‚É£ –ü–æ–ª—É—á–∏—Ç–µ –¥–µ–æ–±—Ñ—É—Å—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –æ–±—Ä–∞—Ç–Ω–æ

‚ö†Ô∏è <b>–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:</b>
‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 20 MB
‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: 30 —Å–µ–∫—É–Ω–¥

üîß <b>–ß—Ç–æ —É–º–µ–µ—Ç –¥–µ–æ–±—Ñ—É—Å–∫–∞—Ç–æ—Ä:</b>
‚Ä¢ –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫
‚Ä¢ –ê–Ω–∞–ª–∏–∑ VM —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
‚Ä¢ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
‚Ä¢ –£–¥–∞–ª–µ–Ω–∏–µ –∞–Ω—Ç–∏-–æ—Ç–ª–∞–¥–∫–∏
‚Ä¢ –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ Base64/Hex/Decimal

‚ùì <b>–ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:</b>
‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª –æ–±—Ñ—É—Å—Ü–∏—Ä–æ–≤–∞–Ω Prometheus/Moonsec
‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–¥–∏—Ä–æ–≤–∫—É —Ñ–∞–π–ª–∞ (UTF-8)
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /status –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–æ—Ç–∞
"""
    await message.answer(help_text, parse_mode=ParseMode.HTML)

@dp.message(Command("status"))
async def cmd_status(message: Message):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–µ–æ–±—Ñ—É—Å–∫–∞—Ç–æ—Ä–∞"""
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª –¥–µ–æ–±—Ñ—É—Å–∫–∞—Ç–æ—Ä–∞
        if not os.path.exists(DEOBFUSCATOR_PATH):
            await message.answer(
                f"‚ùå <b>–î–µ–æ–±—Ñ—É—Å–∫–∞—Ç–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω!</b>\n\n"
                f"–ü—É—Ç—å: <code>{DEOBFUSCATOR_PATH}</code>\n\n"
                f"üìã <b>–ß—Ç–æ –¥–µ–ª–∞—Ç—å:</b>\n"
                f"1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É –ø–æ SSH\n"
                f"2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ: <code>ls -la /app/Prometheus-Deobfuscator/</code>\n"
                f"3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª pol.py —Å—É—â–µ—Å—Ç–≤—É–µ—Ç\n"
                f"4. –ï—Å–ª–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ —Å–∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω:\n"
                f"   <code>cd /app && git clone https://github.com/0x251/Prometheus-Deobfuscator.git</code>",
                parse_mode=ParseMode.HTML
            )
            return
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
        is_executable = os.access(DEOBFUSCATOR_PATH, os.X_OK)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º Python
        process = await asyncio.create_subprocess_exec(
            PYTHON_PATH, "--version",
            stdout=asyncio.subprocess.PIPE,
            stderr=asyncio.subprocess.PIPE
        )
        stdout, _ = await process.communicate()
        python_version = stdout.decode().strip() or "Python 3.x"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É
        temp_writable = os.access(TEMP_DIR, os.W_OK) if os.path.exists(TEMP_DIR) else False
        
        status_text = (
            f"‚úÖ <b>–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç</b>\n\n"
            f"üìÅ <b>–î–µ–æ–±—Ñ—É—Å–∫–∞—Ç–æ—Ä:</b>\n"
            f"  ‚Ä¢ –ü—É—Ç—å: <code>{DEOBFUSCATOR_PATH}</code>\n"
            f"  ‚Ä¢ –°—Ç–∞—Ç—É—Å: {'üü¢ –ù–∞–π–¥–µ–Ω' if os.path.exists(DEOBFUSCATOR_PATH) else 'üî¥ –ù–µ –Ω–∞–π–¥–µ–Ω'}\n"
            f"  ‚Ä¢ –ü—Ä–∞–≤–∞: {'‚úÖ OK' if is_executable else '‚ö†Ô∏è –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ'}\n\n"
            f"üêç <b>Python:</b> {python_version}\n\n"
            f"üìÇ <b>–í—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞–ø–∫–∞:</b>\n"
            f"  ‚Ä¢ –ü—É—Ç—å: <code>{TEMP_DIR}</code>\n"
            f"  ‚Ä¢ –°—Ç–∞—Ç—É—Å: {'üü¢ –ì–æ—Ç–æ–≤–∞' if temp_writable else 'üî¥ –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞'}\n"
        )
        
        await message.answer(status_text, parse_mode=ParseMode.HTML)
        
    except Exception as e:
        await message.answer(
            f"‚ùå <b>–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:</b>\n<code>{str(e)}</code>",
            parse_mode=ParseMode.HTML
        )

@dp.message(lambda message: message.document)
async def handle_document(message: Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤"""
    
    file_name = message.document.file_name or "script.lua"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
    if not file_name.lower().endswith('.lua'):
        await message.reply(
            "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º <code>.lua</code>",
            parse_mode=ParseMode.HTML
        )
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (20 MB –º–∞–∫—Å–∏–º—É–º)
    if message.document.file_size > 20 * 1024 * 1024:
        await message.reply("‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 20 MB")
        return
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
    status_msg = await message.reply(
        f"üì• <b>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞:</b> {file_name}",
        parse_mode=ParseMode.HTML
    )
    
    try:
        # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
        file = await bot.get_file(message.document.file_id)
        file_content = await bot.download_file(file.file_path)
        lua_code = file_content.read().decode('utf-8', errors='ignore')
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        await status_msg.edit_text(
            f"üîÑ <b>–î–µ–æ–±—Ñ—É—Å–∫–∞—Ü–∏—è...</b>\n"
            f"–§–∞–π–ª: {file_name}\n"
            f"–†–∞–∑–º–µ—Ä: {len(lua_code)} —Å–∏–º–≤–æ–ª–æ–≤\n\n"
            f"‚è≥ –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 30 —Å–µ–∫—É–Ω–¥",
            parse_mode=ParseMode.HTML
        )
        
        # –î–µ–æ–±—Ñ—É—Å—Ü–∏—Ä—É–µ–º
        result = await deobfuscate_lua(lua_code, file_name)
        
        if result is None:
            await status_msg.edit_text("‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–µ–æ–±—Ñ—É—Å–∫–∞—Ü–∏–∏")
            return
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—à–∏–±–∫–æ–π
        if result.startswith("‚ùå"):
            await status_msg.edit_text(result, parse_mode=ParseMode.HTML)
            return
        
        # –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª–æ–º
        if len(result) > 3500:
            output_filename = f"deobfuscated_{file_name}"
            output_path = os.path.join(TEMP_DIR, output_filename)
            
            with open(output_path, "w", encoding="utf-8") as f:
                f.write(result)
            
            await message.reply_document(
                document=FSInputFile(output_path),
                caption=f"‚úÖ <b>–î–µ–æ–±—Ñ—É—Å–∫–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</b>\n\n–ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª: {file_name}",
                parse_mode=ParseMode.HTML
            )
            
            # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            try:
                os.remove(output_path)
            except:
                pass
        else:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç
            await message.reply(
                f"‚úÖ <b>–î–µ–æ–±—Ñ—É—Å–∫–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</b>\n\n"
                f"<pre><code class='language-lua'>{result}</code></pre>",
                parse_mode=ParseMode.HTML
            )
        
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ç—É—Å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        await status_msg.delete()
        
    except UnicodeDecodeError:
        await status_msg.edit_text(
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª –≤ –∫–æ–¥–∏—Ä–æ–≤–∫–µ UTF-8."
        )
    except Exception as e:
        await status_msg.edit_text(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: {str(e)[:200]}")

@dp.message()
async def handle_text(message: Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    await message.reply(
        "üìÅ –û—Ç–ø—Ä–∞–≤—å—Ç–µ <b>.lua —Ñ–∞–π–ª</b> –¥–ª—è –¥–µ–æ–±—Ñ—É—Å–∫–∞—Ü–∏–∏\n"
        "–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø—Ä–∞–≤–∫–∏",
        parse_mode=ParseMode.HTML
    )

# ============================================
# –ó–ê–ü–£–°–ö –ë–û–¢–ê
# ============================================
async def main():
    print("=" * 50)
    print("ü§ñ –ó–ê–ü–£–°–ö PROMETHEUS DEOBFUSCATOR BOT")
    print("=" * 50)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–µ–æ–±—Ñ—É—Å–∫–∞—Ç–æ—Ä
    deobfuscator_ok = await check_deobfuscator()
    
    if not deobfuscator_ok:
        print("\n‚ö†Ô∏è  –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω, –Ω–æ –¥–µ–æ–±—Ñ—É—Å–∫–∞—Ç–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        print("   –ö–æ–º–∞–Ω–¥–∞ /status –ø–æ–∫–∞–∂–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é\n")
    else:
        print("\n‚úÖ –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!\n")
    
    print(f"üìÅ –ü—É—Ç—å –∫ –¥–µ–æ–±—Ñ—É—Å–∫–∞—Ç–æ—Ä—É: {DEOBFUSCATOR_PATH}")
    print(f"üêç Python: {PYTHON_PATH}")
    print(f"üìÇ –í—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞–ø–∫–∞: {TEMP_DIR}")
    print("\nüü¢ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω! –ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.")
    print("=" * 50)
    
    await dp.start_polling(bot)

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\n\nüëã –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    except Exception as e:
        print(f"\n‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
